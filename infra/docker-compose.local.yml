# Docker Compose for Local Development
# AI Orchestrator - n8n + Postgres + Backend
#
# Usage:
#   1. Copy .env.local.example to .env.local and fill in values
#   2. Run: docker compose -f docker-compose.local.yml --env-file .env.local up -d
#   3. Access n8n at http://localhost:5678
#   4. Access backend at http://localhost:3001

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ai-orchestrator-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-orchestrator}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-orchestrator_password}
      POSTGRES_DB: ${POSTGRES_DB:-orchestrator}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-orchestrator} -d ${POSTGRES_DB:-orchestrator}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: ai-orchestrator-n8n
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database Configuration
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-orchestrator}
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-orchestrator}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:-orchestrator_password}

      # n8n Configuration
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: ${N8N_PORT:-5678}
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      WEBHOOK_URL: ${WEBHOOK_URL:-http://localhost:5678}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # Basic Auth (optional but recommended)
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-true}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}

      # Execution Settings
      EXECUTIONS_DATA_PRUNE: "true"
      EXECUTIONS_DATA_MAX_AGE: 168
      GENERIC_TIMEZONE: ${TIMEZONE:-UTC}

      # External API Keys (for AI nodes)
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # Allow local network access for backend communication
      N8N_SECURE_COOKIE: "false"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-workflows:/home/node/workflows:ro
    ports:
      - "${N8N_PORT:-5678}:5678"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Backend API Service (optional - can run locally instead)
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: ai-orchestrator-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      BACKEND_PORT: ${BACKEND_PORT:-3001}
      BACKEND_HOST: 0.0.0.0

      # Database
      DATABASE_URL: postgres://${POSTGRES_USER:-orchestrator}:${POSTGRES_PASSWORD:-orchestrator_password}@postgres:5432/${POSTGRES_DB:-orchestrator}

      # n8n Integration
      N8N_BASE_URL: http://n8n:5678
      N8N_API_KEY: ${N8N_API_KEY}

      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Safety
      DEV_ONLY_MODE: ${DEV_ONLY_MODE:-true}
      MAX_FIX_RETRIES: ${MAX_FIX_RETRIES:-3}
    ports:
      - "${BACKEND_PORT:-3001}:3001"
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  postgres_data:
    driver: local
  n8n_data:
    driver: local

networks:
  default:
    name: ai-orchestrator-network
